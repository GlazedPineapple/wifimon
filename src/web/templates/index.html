<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>WiFiMon</title>
    <!--    <link rel="stylesheet" href="style.css">-->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.sidebar button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.sidebar button').forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                });
            });
        });
    </script>

</head>


<body>
<header>
    <h1>WiFiMon</h1>
</header>
<div class="input-bar">
    <label id="input-label" class="input-label">No Selection</label>
    <div class="input-group">
        <label for="input-text">Interface (Ex: wlan1)</label>
        <input id="input-text" type="text" placeholder=""/>
    </div>
    <div class="input-group">
        <label for="input-id">Target IP/SSID</label>
        <input id="input-id" type="text" placeholder=""/>
    </div>
    <div class="input-group">
        <label for="monitor-toggle">Monitor Mode (wlan1)</label>
        <label class="switch">
            <input type="checkbox" id="monitor-toggle">
            <span class="slider round"></span>
        </label>
    </div>
</div>

<div class="container">
    <div class="sidebar">
        <div class="sidebar-grid">
            <button data-text="Alpha" data-id="1">List Interfaces</button>
            <button data-text="Alpha" data-id="1">Ping</button>
            <button data-text="Beta" data-id="2">Packet Sniffer</button>
            <button data-text="Gamma" data-id="3">Beacon Scanner</button>
            <button data-text="Delta" data-id="4">Probe Tracker</button>
            <button data-text="Echo" data-id="4">WiFi Analyzer</button>
            <button data-text="Echo" data-id="4">WiFi Teacher</button>
            <button>EAP Module</button>
        </div>
    </div>
    <div class="main">
        <div class="controls">
            <button id="start">Start</button>
            <button id="stop">Stop</button>
            <button id="clear">Clear</button>
        </div>
        <textarea id="pi-output" placeholder="Output will appear here..." readonly></textarea>
</div>

<script>
    let eventSource = null;
    let selectedEndpoint = null;
    const TEXT_BOX_SIZE = 10000;

    function startStream(endpoint, iface, target) {
        if (eventSource) {
            eventSource.close();
        }

        // Encode query parameters safely
        const url = `${endpoint}?iface=${encodeURIComponent(iface)}&target=${encodeURIComponent(target)}`;
        eventSource = new EventSource(url);

        const textarea = document.getElementById("pi-output");

        eventSource.onmessage = function (event) {
            textarea.value += event.data + "\n";
            if (textarea.value.length > TEXT_BOX_SIZE) {
                textarea.value = textarea.value.substring(textarea.value.length - TEXT_BOX_SIZE);
            }
            textarea.scrollTop = textarea.scrollHeight;
        };


        eventSource.onerror = function () {
            console.error("Stream error. Closing stream.");
            eventSource.close();
        };
    }

    // Handle sidebar button clicks (set endpoint only)
    document.querySelectorAll('.sidebar button').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.sidebar button').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');

            document.getElementById('input-label').textContent = button.textContent;
            selectedEndpoint = "/" + button.textContent.toLowerCase().replace(/\s+/g, '-');
        });
    });

    // Start button
    document.getElementById('start').addEventListener('click', () => {
        const iface = document.getElementById("input-text").value.trim();
        const target = document.getElementById("input-id").value.trim();

        if (!selectedEndpoint) {
            alert("Please select a module from the sidebar.");
            return;
        }

        startStream(selectedEndpoint, iface, target);
    });

    // Stop button
    document.getElementById('stop').addEventListener('click', () => {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
    });

    document.getElementById("clear").addEventListener("click", () => {
        document.getElementById("pi-output").value = "";
    });

    document.getElementById("monitor-toggle").addEventListener("change", async function () {
        const enabled = this.checked;
        const response = await fetch(`/monitor-mode?iface=wlan1&enable=${enabled}`, {
            method: "POST"
        });
        const text = await response.text();
        if (response.code !== 200) {
            alert(text)
        }
    });
</script>
</body>

</html>